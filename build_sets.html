<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script>
       const endpoint = "https://script.google.com/macros/s/AKfycbxxWX3FrfYFe_MkTF953ILf-Br_saVTheG-NQw-Olp3UWHSXbEjCryEUDoktTWJS47jpw/exec" 

        async function start_me_up(){
            let set_name = new URLSearchParams(window.location.search).get('set');
            let load = new URLSearchParams(window.location.search).get('load');
            if(!sessionStorage.getItem("group") || load==="true"){
                await get_data()
            }
            const person = JSON.parse(sessionStorage.getItem("person"))
            const pid = JSON.parse(sessionStorage.getItem("pid"))
            const group = JSON.parse(sessionStorage.getItem("group"))

            
            for(const [id, grp] of Object.entries(group)){
              //console.log(grp.fields.shortname,set_name)  
              if(grp.fields.shortname===set_name){   
                let image_url=grp.fields.image_url
                if(!image_url){
                    image_url=set_name + ".png"
                }
                
                const report={
                    title: grp.fields.group_name,
                    desc: grp.fields.description,
                    banner: image_url,
                    backgroundColor: "#fff",
                    textColor: "#000",
                    people:[]
                }
                const data = grp.fields
                //console.log(data.group_name, grp.id, data.members.length)
                for(const member of data.members){
                    if(person[member].fields.pid && pid[person[member].fields.pid[0]].fields.pid.toUpperCase()!=="SKIP"){

                        //console.log("member", pid[person[member].fields.pid[0]].fields.pid)

                        report.people.push({
                            pid: pid[person[member].fields.pid[0]].fields.pid,
                            name: person[member].fields.full_name,
                            desc: person[member].fields.blurb,
                            url: person[member].fields.url,
                        })
                        //console.log(person[member].fields.full_name, pid[person[member].fields.pid].fields.pid, person[member].fields.blurb)
                    }

                }
               document.body.innerHTML="<pre>"+JSON.stringify(report, null, 2)+"</pre>"
              }
            }
            //document.body.innerHTML = "<pre>" + JSON.stringify(data,null,2) + "</pre>"
        }

        async function get_data(){
            const data={
                person:null,
                group:null,
                pid:null
            }
            for(const key of Object.keys(data)){
                const result = await get_table(key)
                //console.log("key",key)
                //console.log("data",result)
                tag(key).innerHTML = Object.keys(result).length
            }

        }

        async function get_table(tablename){
            const url= endpoint+"?mode=table&name=" + tablename
            //console.log(url)
            const response  = await fetch(url)
            const text = await response.text();
            const table = {}
            const data = JSON.parse(text)

            for(record of data){
                table[record.id] = record
            }

            sessionStorage.setItem(tablename,JSON.stringify(table))
            return table
        }


        function tag(id){
            return document.getElementById(id)
        }

    </script>
</head>
<body onload="start_me_up()">
    Getting data from airtable
    <table><tr><td>
        People:
        </td><td id="person"></td></tr><td>
        PIDs:
        </td><td id="pid"></td></tr><td>
        Groups:
        </td><td id="group"></td></tr>
    </table>
    <div id="output"></div>
</body>
</html>